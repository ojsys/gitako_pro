{% extends 'base_dashboard.html' %}

{% block title %}Add New Staff Member - Gitako{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <a href="{% url 'farms:staff' %}" class="text-decoration-none text-muted me-2">
            <i class="material-icons">arrow_back</i>
        </a>
        Add New Staff Member
    </h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="post" id="staffForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- Progress Steps -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="step-indicator active" data-step="1">
                                    <div class="step-circle">
                                        <i class="material-icons">person</i>
                                    </div>
                                    <span class="step-label">Personal Info</span>
                                </div>
                                <div class="step-line"></div>
                                <div class="step-indicator" data-step="2">
                                    <div class="step-circle">
                                        <i class="material-icons">security</i>
                                    </div>
                                    <span class="step-label">Account Details</span>
                                </div>
                                <div class="step-line"></div>
                                <div class="step-indicator" data-step="3">
                                    <div class="step-circle">
                                        <i class="material-icons">work</i>
                                    </div>
                                    <span class="step-label">Employment Info</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 1: Personal Information -->
            <div class="step-content active" data-step="1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="material-icons me-2">person</i>
                            Personal Information
                        </h5>
                        <small class="text-muted">Basic information about the staff member</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                        First Name <span class="text-danger">*</span>
                                    </label>
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.first_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                        Last Name <span class="text-danger">*</span>
                                    </label>
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.last_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">
                                        Email Address <span class="text-danger">*</span>
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.email.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">This will be used for login and communication</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                        Phone Number
                                    </label>
                                    {{ form.phone_number }}
                                    {% if form.phone_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.phone_number.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label">
                                Address
                            </label>
                            {{ form.address }}
                            {% if form.address.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.address.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label">
                                        City
                                    </label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.city.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.state.id_for_label }}" class="form-label">
                                        State
                                    </label>
                                    {{ form.state }}
                                    {% if form.state.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.state.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Account Details -->
            <div class="step-content" data-step="2">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="material-icons me-2">security</i>
                            Account Details
                        </h5>
                        <small class="text-muted">Login credentials for the staff member</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.username.id_for_label }}" class="form-label">
                                        Username <span class="text-danger">*</span>
                                    </label>
                                    {{ form.username }}
                                    {% if form.username.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.username.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.username.help_text %}
                                        <div class="form-text">{{ form.username.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.password1.id_for_label }}" class="form-label">
                                        Password <span class="text-danger">*</span>
                                    </label>
                                    {{ form.password1 }}
                                    {% if form.password1.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.password1.errors.0 }}
                                        </div>
                                    {% endif %}
                                    {% if form.password1.help_text %}
                                        <div class="form-text">{{ form.password1.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.password2.id_for_label }}" class="form-label">
                                        Confirm Password <span class="text-danger">*</span>
                                    </label>
                                    {{ form.password2 }}
                                    {% if form.password2.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.password2.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="material-icons me-2">info</i>
                            The staff member will receive these login credentials to access their account.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Employment Information -->
            <div class="step-content" data-step="3">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="material-icons me-2">work</i>
                            Employment Information
                        </h5>
                        <small class="text-muted">Job details and farm assignment</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.farm.id_for_label }}" class="form-label">
                                        Farm Assignment <span class="text-danger">*</span>
                                    </label>
                                    {{ form.farm }}
                                    {% if form.farm.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.farm.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.role.id_for_label }}" class="form-label">
                                        Role <span class="text-danger">*</span>
                                    </label>
                                    {{ form.role }}
                                    {% if form.role.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.role.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.hire_date.id_for_label }}" class="form-label">
                                        Hire Date
                                    </label>
                                    {{ form.hire_date }}
                                    {% if form.hire_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.hire_date.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.salary.id_for_label }}" class="form-label">
                                        Monthly Salary (â‚¦)
                                    </label>
                                    {{ form.salary }}
                                    {% if form.salary.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.salary.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                Additional Notes
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.notes.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <div>
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                        <i class="material-icons me-1">arrow_back</i>
                        Previous
                    </button>
                </div>
                <div>
                    <a href="{% url 'farms:staff' %}" class="btn btn-outline-secondary me-2">
                        <i class="material-icons me-1">cancel</i>
                        Cancel
                    </a>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Next
                        <i class="material-icons ms-1">arrow_forward</i>
                    </button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                        <i class="material-icons me-1">person_add</i>
                        Create Staff Member
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <div class="col-lg-4">
        <!-- Help Card -->
        <div class="card sticky-top">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="material-icons me-1">help</i>
                    Creating Staff Accounts
                </h6>
            </div>
            <div class="card-body">
                <div class="help-section" data-step="1">
                    <h6 class="text-primary">Personal Information</h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Provide accurate contact information</small>
                        </li>
                        <li class="mb-2">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Email will be used for account notifications</small>
                        </li>
                        <li class="mb-0">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Address helps with staff management</small>
                        </li>
                    </ul>
                </div>

                <div class="help-section" data-step="2" style="display: none;">
                    <h6 class="text-primary">Account Security</h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Choose a unique username</small>
                        </li>
                        <li class="mb-2">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Password must be at least 8 characters</small>
                        </li>
                        <li class="mb-0">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Staff will use these to login</small>
                        </li>
                    </ul>
                </div>

                <div class="help-section" data-step="3" style="display: none;">
                    <h6 class="text-primary">Employment Setup</h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Assign to appropriate farm</small>
                        </li>
                        <li class="mb-2">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Select role based on responsibilities</small>
                        </li>
                        <li class="mb-0">
                            <i class="material-icons text-success me-1" style="font-size: 1rem;">check_circle</i>
                            <small>Salary information is optional</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.step-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    flex: 1;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.step-indicator.active .step-circle {
    background-color: #0d6efd;
}

.step-indicator.completed .step-circle {
    background-color: #198754;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
    text-align: center;
}

.step-indicator.active .step-label {
    color: #0d6efd;
}

.step-indicator.completed .step-label {
    color: #198754;
}

.step-line {
    height: 2px;
    background-color: #dee2e6;
    flex: 1;
    margin: 0 15px;
    margin-top: 25px;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.sticky-top {
    top: 1rem !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 3;

    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');

    function showStep(step) {
        // Hide all step contents
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });

        // Show current step content
        const currentContent = document.querySelector(`.step-content[data-step="${step}"]`);
        if (currentContent) {
            currentContent.classList.add('active');
        }

        // Update step indicators
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
            const stepNumber = index + 1;
            indicator.classList.remove('active', 'completed');
            
            if (stepNumber < step) {
                indicator.classList.add('completed');
            } else if (stepNumber === step) {
                indicator.classList.add('active');
            }
        });

        // Update help sections
        document.querySelectorAll('.help-section').forEach(section => {
            section.style.display = 'none';
        });
        const helpSection = document.querySelector(`.help-section[data-step="${step}"]`);
        if (helpSection) {
            helpSection.style.display = 'block';
        }

        // Update button visibility
        if (step === 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        } else if (step === totalSteps) {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
        } else {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
        }
    }

    function validateStep(step) {
        const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
        const requiredFields = stepContent.querySelectorAll('input[required], select[required]');
        let isValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        // Additional validation for step 2 (passwords)
        if (step === 2) {
            const password1 = document.querySelector('input[name="password1"]');
            const password2 = document.querySelector('input[name="password2"]');
            
            if (password1.value !== password2.value) {
                password2.classList.add('is-invalid');
                isValid = false;
            }
        }

        return isValid;
    }

    nextBtn.addEventListener('click', function() {
        if (validateStep(currentStep)) {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
    });

    prevBtn.addEventListener('click', function() {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    // Initialize first step
    showStep(currentStep);

    // Set today's date as default for hire_date
    const hireDateField = document.querySelector('input[name="hire_date"]');
    if (hireDateField && !hireDateField.value) {
        const today = new Date().toISOString().split('T')[0];
        hireDateField.value = today;
    }
});
</script>
{% endblock %}